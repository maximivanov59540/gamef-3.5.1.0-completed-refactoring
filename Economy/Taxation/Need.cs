using UnityEngine;

/// <summary>
/// Базовая потребность жилого дома (еда, одежда и т.д.)
/// Система работает как Anno 1800: настраиваете сколько ресурса нужно и какие бонусы это дает
/// </summary>
[System.Serializable]
public class Need
{
    [Header("=== Потребление Ресурса ===")]
    [Tooltip("Тип ресурса (Рыба, Одежда, и т.д.)")]
    public ResourceType resourceType;

    [Tooltip("Сколько этого ресурса потребляет ОДИН дом за 1 минуту\n\n" +
             "ПРИМЕР: Если хотите чтобы 10 домов потребляли 1 Рыбу/мин:\n" +
             "  amountPerMinute = 1.0 / 10 = 0.1 (на 1 дом)\n\n" +
             "ФОРМУЛА: [Нужно в минуту на N домов] ÷ N = amountPerMinute")]
    public float amountPerMinute = 0.1f;

    [Header("=== КАТЕГОРИЯ (для UI и логики) ===")]
    [Tooltip("Категория потребности:\n\n" +
             "• Basic - Базовая потребность (еда, вода)\n" +
             "• Comfort - Потребности довольства (одежда, мебель)\n" +
             "• Personal - Персональные потребности (развлечения, образование)\n" +
             "• Luxury - Потребности роскоши (украшения, деликатесы)")]
    public NeedCategory category = NeedCategory.Basic;

    [Header("=== БОНУСЫ: Если Потребность УДОВЛЕТВОРЕНА ===")]

    [Tooltip("+ Сколько ЖИТЕЛЕЙ дает эта потребность\n\n" +
             "ПРИМЕР:\n" +
             "  Базовая еда (Рыба) = +5 жителей\n" +
             "  Одежда = +3 жителя\n" +
             "  Пиво = +2 жителя\n\n" +
             "ИТОГО при всех потребностях: 5+3+2 = 10 жителей на дом")]
    public int populationBonus = 5;

    [Tooltip("+ Бонус к СЧАСТЬЮ (за цикл потребления)\n\n" +
             "РЕКОМЕНДУЕТСЯ:\n" +
             "  Базовые нужды (еда) = +0.5\n" +
             "  Комфорт (одежда) = +0.3\n" +
             "  Роскошь (пиво) = +0.2")]
    public float happinessBonus = 0.5f;

    [Tooltip("+ Дополнительный НАЛОГ (за цикл потребления)\n\n" +
             "РЕКОМЕНДУЕТСЯ:\n" +
             "  Базовые нужды = +0.5 золота\n" +
             "  Комфорт = +1.0 золота\n" +
             "  Роскошь = +2.0 золота")]
    public float taxBonusPerCycle = 0.5f;

    [Header("=== ШТРАФЫ: Если Потребность НЕ УДОВЛЕТВОРЕНА ===")]

    [Tooltip("- Штраф к СЧАСТЬЮ (за цикл потребления)\n\n" +
             "РЕКОМЕНДУЕТСЯ (отрицательные значения!):\n" +
             "  Базовые нужды (еда) = -1.0 (критично!)\n" +
             "  Комфорт (одежда) = -0.5\n" +
             "  Роскошь (пиво) = -0.2 (некритично)")]
    public float happinessPenalty = -1.0f;

    [Header("=== МОДИФИКАТОРЫ СОБЫТИЙ ===")]

    [Tooltip("Снижение шанса пандемии (0-1)\n\n" +
             "ПРИМЕР:\n" +
             "  Мешочек целебных трав = 0.2 (снижает шанс пандемии на 20%)\n" +
             "  Базовая медицина = 0.1 (снижает на 10%)\n\n" +
             "Работает только если потребность УДОВЛЕТВОРЕНА")]
    [Range(0f, 1f)]
    public float pandemicChanceReduction = 0f;

    [Tooltip("Снижение шанса бунта (0-1)\n\n" +
             "ПРИМЕР:\n" +
             "  Развлечения = 0.15 (снижает шанс бунта на 15%)\n" +
             "  Хорошая еда = 0.1 (снижает на 10%)\n\n" +
             "Работает только если потребность УДОВЛЕТВОРЕНА")]
    [Range(0f, 1f)]
    public float riotChanceReduction = 0f;

    [Header("=== РАЗБЛОКИРОВКА (Anno 1800 Progression) ===")]

    [Tooltip("Требует ли эта потребность разблокировки?\n\n" +
             "FALSE (по умолчанию) = Доступна сразу с первого дома\n" +
             "TRUE = Разблокируется при достижении определенного населения\n\n" +
             "ПРИМЕР ПРОГРЕССИИ:\n" +
             "  Farmers (смерды):\n" +
             "    • Рыба - доступна сразу (requiresUnlock = false)\n" +
             "  \n" +
             "  Craftsmen (посадские) - требует 50 смердов:\n" +
             "    • Одежда - requiresUnlock = true, unlockAtPopulation = 50, unlockPopulationTier = Farmers\n" +
             "  \n" +
             "  Artisans (цеховые) - требует 100 посадских:\n" +
             "    • Пиво - requiresUnlock = true, unlockAtPopulation = 100, unlockPopulationTier = Craftsmen")]
    public bool requiresUnlock = false;

    [Tooltip("Какой КЛАСС населения нужен для разблокировки\n\n" +
             "Используется только если requiresUnlock = true\n\n" +
             "ПРИМЕРЫ:\n" +
             "  • Farmers - нужно определенное количество смердов\n" +
             "  • Craftsmen - нужно определенное количество посадских\n" +
             "  • Artisans - нужно определенное количество цеховых")]
    public PopulationTier unlockPopulationTier = PopulationTier.Farmers;

    [Tooltip("Сколько жителей нужно для разблокировки\n\n" +
             "Используется только если requiresUnlock = true\n\n" +
             "ПРИМЕРЫ:\n" +
             "  • 50 смердов → разблокирует Одежду\n" +
             "  • 100 посадских → разблокирует Пиво\n" +
             "  • 200 цеховых → разблокирует роскошь")]
    public int unlockAtPopulation = 50;

    /// <summary>
    /// Проверяет разблокирована ли эта потребность
    /// (вызывается из Residence.cs)
    /// </summary>
    public bool IsUnlocked()
    {
        // Если не требует разблокировки - доступна сразу
        if (!requiresUnlock)
            return true;

        // Проверяем текущее население нужного класса
        if (ResourceManager.Instance == null || ResourceManager.Instance.Population == null)
        {
            Debug.LogWarning($"[Need] Population не найден! Потребность {resourceType} считается НЕ разблокированной.");
            return false;
        }

        int currentPop = ResourceManager.Instance.Population.GetCurrentPopulation(unlockPopulationTier);
        bool unlocked = currentPop >= unlockAtPopulation;

        return unlocked;
    }
}

// ============================================================================
// ПРИМЕРЫ НАСТРОЙКИ (для копирования в Unity Inspector):
// ============================================================================
//
// --- ПРИМЕР 1: Базовая еда (Рыба) - Доступна сразу ---
// resourceType = Fish
// amountPerMinute = 0.1           // 10 домов = 1 рыба/мин
// populationBonus = 5             // +5 жителей когда есть еда
// happinessBonus = 0.5            // +0.5 счастья
// taxBonusPerCycle = 0.5          // +0.5 золота
// happinessPenalty = -1.0         // -1.0 счастья (голод - критично!)
// requiresUnlock = false          // ✓ Доступна сразу!
//
// --- ПРИМЕР 2: Одежда (Комфорт) - Требует 50 смердов ---
// resourceType = Clothes
// amountPerMinute = 0.05          // 20 домов = 1 одежда/мин
// populationBonus = 3             // +3 жителя
// happinessBonus = 0.3            // +0.3 счастья
// taxBonusPerCycle = 1.0          // +1.0 золота (платят больше за комфорт)
// happinessPenalty = -0.5         // -0.5 счастья
// requiresUnlock = true           // ✓ Требует разблокировки!
// unlockPopulationTier = Farmers  // Нужны Farmers (смерды)
// unlockAtPopulation = 50         // Минимум 50 смердов
//
// --- ПРИМЕР 3: Пиво (Роскошь) - Требует 100 посадских ---
// resourceType = Beer
// amountPerMinute = 0.033         // 30 домов = 1 пиво/мин
// populationBonus = 2             // +2 жителя
// happinessBonus = 0.2            // +0.2 счастья
// taxBonusPerCycle = 2.0          // +2.0 золота (роскошь дорого стоит)
// happinessPenalty = -0.2         // -0.2 счастья (не критично)
// requiresUnlock = true           // ✓ Требует разблокировки!
// unlockPopulationTier = Craftsmen // Нужны Craftsmen (посадские)
// unlockAtPopulation = 100        // Минимум 100 посадских
//
// ============================================================================
// МЕХАНИКА РАЗБЛОКИРОВКИ (Anno 1800):
// ============================================================================
//
// Пока потребность ЗАБЛОКИРОВАНА:
//   • НЕ потребляется (ресурс не списывается)
//   • НЕ дает бонусы (население, счастье, налоги)
//   • НЕ дает штрафы (нет негатива от отсутствия)
//   • Дом работает так, будто этой потребности не существует
//
// После РАЗБЛОКИРОВКИ (достигли нужного населения):
//   • Начинает потребляться автоматически
//   • Применяются все бонусы и штрафы
//   • Появляется в UI (если реализовано)
//
// Прогрессия населения (Anno 1800):
//   Farmers (смерды) → требуют базовые нужды (Рыба)
//   ↓ Достигли 50 смердов
//   Craftsmen (посадские) → разблокируется Одежда
//   ↓ Достигли 100 посадских
//   Artisans (цеховые) → разблокируется Пиво
//
// ============================================================================